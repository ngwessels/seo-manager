import{__awaiter as e}from"../../../node_modules/tslib/tslib.es6.js";import t from"react";import"../styles.css.js";import s from"../../../node_modules/@mui/icons-material/Close.js";import i from"../../../node_modules/@mui/icons-material/FileUploadOutlined.js";import{firebase as l}from"../../../firebase.js";import{getStorage as o,ref as r,uploadBytesResumable as a,getDownloadURL as n}from"../../../node_modules/@firebase/storage/dist/index.esm2017.js";import{n as d}from"../../../node_modules/@firebase/auth/dist/esm2017/index-58473f72.js";import"../../../node_modules/@firebase/app/dist/esm/index.esm2017.js";import"../../../node_modules/@firebase/logger/dist/esm/index.esm2017.js";import{addFiles as m}from"../utils.js";import{serverCall as p}from"../../../utils/call.js";import c from"./File.js";import u from"../../../node_modules/@mui/material/styles/styled.js";import h from"../../../node_modules/@mui/material/Dialog/Dialog.js";import f from"../../../node_modules/@mui/material/DialogTitle/DialogTitle.js";import g from"../../../node_modules/@mui/material/IconButton/IconButton.js";import y from"../../../node_modules/@mui/material/DialogContent/DialogContent.js";import v from"../../../node_modules/@mui/material/CircularProgress/CircularProgress.js";import E from"../../../node_modules/@mui/material/Grid/Grid.js";import I from"../../../node_modules/@mui/material/Typography/Typography.js";import j from"../../../node_modules/@mui/material/DialogActions/DialogActions.js";import x from"../../../node_modules/@mui/material/Box/Box.js";import C from"../../../node_modules/@mui/material/LinearProgress/LinearProgress.js";import b from"../../../node_modules/@mui/material/Button/Button.js";import D from"../../../node_modules/@mui/lab/LoadingButton/LoadingButton.js";const _=o(l),A=d(l),S=u(h)((({theme:e})=>({"& .MuiDialogContent-root":{padding:e.spacing(2)},"& .MuiDialogActions-root":{padding:e.spacing(1)},"& .MuiPaper-root":{margin:"0px",width:"90vw",maxWidth:"900px"}})));class P extends t.Component{constructor(t){super(t),this.componentDidMount=()=>{this.getData()},this.componentDidUpdate=e=>{!0===this.props.open&&!1===e.open&&(this.setState({loading:!0,selected:!0===this.props.multiple&&this.props.selected?{url:"",fileId:""}:Object.assign({},this.props.selected),selectedArray:!0===this.props.multiple&&this.props.selected?[...this.props.selected]:[]}),this.getData()),!1===this.props.open&&!0===e.open&&(this.setState({loading:!0,selected:{url:"",fileId:""},selectedArray:[],fileError:""}),this.getData()),JSON.stringify(this.props.selected)!==JSON.stringify(e.selected)&&this.setState({selected:!0===this.props.multiple&&this.props.selected?{url:"",fileId:""}:Object.assign({},this.props.selected),selectedArray:!0===this.props.multiple&&this.props.selected?[...this.props.selected]:[]})},this.getData=()=>e(this,void 0,void 0,(function*(){var e,t;const s=yield p("/files/getProjectFiles","get",{},void 0,{X_Authorization:yield null===(e=null==A?void 0:A.currentUser)||void 0===e?void 0:e.getIdToken(),AuthorizationId:null===(t=null==A?void 0:A.currentUser)||void 0===t?void 0:t.uid});s.results.files.length>0?this.setState({files:s.results.files,loading:!1}):this.setState({loading:!1})})),this.imageClicked=e=>{var t,s;const i={url:e.url,fileId:e.fileId};if(this.props.accept&&!(null===(s=null===(t=this.props)||void 0===t?void 0:t.accept)||void 0===s?void 0:s.includes(null==e?void 0:e.contentType)))return this.setState({fileError:`Only accepting ${this.props.accept}`});if(this.setState({fileError:""}),!0===this.props.multiple){let t=[];this.state.selectedArray&&(t=[...this.state.selectedArray]);const s=t.findIndex((t=>{if(t.fileId===e.fileId)return!0}));s>=0?(t.splice(s,1),this.setState({selectedArray:t})):(t.push(i),this.setState({selectedArray:t}))}else this.state.selected.fileId===e.fileId?this.setState({selected:{url:"",fileId:""}}):this.setState({selected:i})},this.addFile=e=>{const t=m(e);if(t&&!t.error&&t.results.length>0){let e=t.results;this.uploadNewFile(e)}else t.error&&this.setState({fileError:t.error})},this.uploadNewFile=t=>new Promise(((s,i)=>e(this,void 0,void 0,(function*(){var s,i;try{const l=yield null===(s=null==A?void 0:A.currentUser)||void 0===s?void 0:s.getIdToken(),o=yield p("/files/generateFileIds","post",{type:"default",qty:t.length+1},void 0,{X_Authorization:l,AuthorizationId:null===(i=null==A?void 0:A.currentUser)||void 0===i?void 0:i.uid}),d=Object.keys(t).map((s=>new Promise(((i,d)=>e(this,void 0,void 0,(function*(){var e;const d=t[s],m=d.object,p=d.name,c=o.results.photoId[s],u={contentType:m.type,cacheControl:"public,max-age=604800",customMetadata:{type:"default",userIdToken:l,userId:null===(e=null==A?void 0:A.currentUser)||void 0===e?void 0:e.uid,fileName:p,fileId:c,projectId:this.props.data.projectId}},h=`projects/${this.props.data.projectId}/files/${c}`,f=r(_,h),g=a(f,m,u);return g.on("state_changed",(e=>{const t=e.bytesTransferred/e.totalBytes*100,s=this.state.uploadProgress;s[c]=t,this.setState({uploadProgress:s})}),(e=>(console.error("Error:",e),i({error:!0,results:!1}))),(()=>{n(g.snapshot.ref).then((e=>{const t={url:e,fileId:c,contentType:m.type,size:m.size,location:h,fileName:p};return i(t)}))}))})))))),m=[...yield Promise.all(d),...this.state.files];this.setState({files:m,fileError:"",uploadProgress:{}})}catch(e){console.error("Error:",e),this.setState({uploadProgress:{}})}})))),this.save=()=>{!0===this.props.multiple?this.props.onChangeComplete(this.state.selectedArray):this.props.onChangeComplete(this.state.selected),this.props.onClose()},this.fileDeleted=(e,t)=>{const s=this.state.files;if(s.splice(t,1),this.setState({files:s}),!0===this.props.multiple){let t=this.state.selectedArray;const s=t.findIndex((t=>{if(t.fileId===e.fileId)return!0}));s>=0&&(t.splice(s,1),this.setState({selectedArray:t}),this.props.onChangeComplete(t))}else{let t=this.state.selected;e.fileId===t.fileId&&(this.setState({selected:{url:"",fileId:""}}),this.props.onChangeComplete({url:"",fileId:""}))}},this.state={files:[],loading:!0,selected:!0===t.multiple&&t.selected?{url:"",fileId:""}:Object.assign({},t.selected),selectedArray:!0===t.multiple&&t.selected?[...t.selected]:[],fileError:"",uploadProgress:{}}}render(){var e,l,o,r;let a=0,n=0;Object.keys(this.state.uploadProgress).forEach((e=>{const t=this.state.uploadProgress[e];a+=100,n=t}));const d=n/a*100;return t.createElement(t.Fragment,null,t.createElement(S,{onClose:this.props.onClose,"aria-labelledby":"customized-dialog-title",open:this.props.open,maxWidth:!1},t.createElement(f,{sx:{m:0,p:2}},"File Manager",t.createElement(g,{"aria-label":"close",onClick:this.props.onClose,sx:{position:"absolute",right:8,top:8,color:e=>e.palette.grey[500]}},t.createElement(s,null))),t.createElement(y,null,this.state.loading&&t.createElement("div",{style:{width:"100%",height:400,display:"flex",justifyContent:"center",alignItems:"center"}},t.createElement(v,null)),!1===this.state.loading&&(null===(l=null===(e=this.state)||void 0===e?void 0:e.files)||void 0===l?void 0:l.length)>0&&t.createElement("div",{style:{display:"flex",flexDirection:"column",minHeight:150}},t.createElement("div",{style:{},className:"top"},this.props.accept&&t.createElement(E,{item:!0,xs:12,mb:2},t.createElement(I,{textAlign:"center"},"Only accepting ",this.props.accept))),t.createElement("div",{className:"fileViewer"},this.state.files.map(((e,s)=>{let i=!1;if(!0===this.props.multiple){this.state.selectedArray.find((t=>t.fileId===e.fileId))&&(i=!0)}else this.state.selected.fileId===e.fileId&&(i=!0);return t.createElement(c,{isClicked:i,key:`Photo-${s}`,onClick:()=>this.imageClicked(e),item:e,idx:s,onDelete:this.fileDeleted})})))),!1===this.state.loading&&0===(null===(r=null===(o=this.state)||void 0===o?void 0:o.files)||void 0===r?void 0:r.length)&&t.createElement("div",{style:{width:"100%",height:400,display:"flex",justifyContent:"center",alignItems:"center"}},t.createElement(I,null,"Add your first files"))),t.createElement(j,null,t.createElement("div",{className:"modal-footer",style:{width:"100%",display:"flex",flexDirection:"column"}},!1===this.state.loading&&t.createElement("div",{className:"file-upload mb-3",style:{height:70,width:"100%"}},t.createElement("input",{className:"file-input",type:"file",onChange:this.addFile,multiple:!0,style:{zIndex:2}}),t.createElement("div",{className:"overlay"}),t.createElement("div",{style:{zIndex:0}},t.createElement(i,{fontSize:"large"})),t.createElement("div",{className:"card-subtitle"},t.createElement(I,{textAlign:"center"},"Drag and drop a file here or click"))),d<100&&t.createElement(x,{sx:{width:"100%"}},t.createElement(C,{variant:"determinate",value:d})),this.state.fileError&&t.createElement("div",{className:"alert alert-danger d-flex align-items-center mb-3",role:"alert",style:{width:"100%"}},t.createElement(I,null,this.state.fileError)),t.createElement("div",{style:{display:"flex",flexDirection:"row",justifyContent:"space-between",alignItems:"center",width:"100%"}},t.createElement(b,{variant:"text",id:"close-seo-manager",onClick:this.props.onClose,type:"button"},"Close"),t.createElement(D,{variant:"text",onClick:this.save,type:"button",loading:!1},"Save"))))))}}export default P;
//# sourceMappingURL=Files.js.map
